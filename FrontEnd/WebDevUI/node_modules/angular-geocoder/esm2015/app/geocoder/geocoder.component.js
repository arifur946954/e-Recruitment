import { Component, Input, Output, EventEmitter, ViewChild, HostListener } from '@angular/core';
import { GeocoderService } from './geocoder.service';
import { FormControl, FormGroup } from '@angular/forms';
import { debounceTime, switchMap, distinctUntilChanged, filter } from 'rxjs/operators';
// Leaflet requires the old school way for importing
export class GeocoderComponent {
    constructor(geocoderService) {
        this.geocoderService = geocoderService;
        this.resultCountLimit = 10;
        this.resultFieldsToShow = [];
        this.placeFound = new EventEmitter();
        this.formattedPlaceholder = '';
        this.resultsVisible = true;
        this.places = [];
        this.collations = [];
        this.searchThreshold = 2;
        this.foundPlace = null;
        this.selectedItem = [];
        this.selectedIndex = -1;
        this.subscriptions = [];
        this.searchField = new FormControl();
        this.searchForm = new FormGroup({ search: this.searchField });
        this.subscriptions.push(this.subscribeToSearchFieldValueChanges());
    }
    clickout(event) {
        if (this.geocoderRef.nativeElement.contains(event.target)) {
            this.showResults();
        }
        else {
            this.hideResults();
        }
    }
    ngOnInit() {
        this.formattedPlaceholder = this.formatPlaceholder(this.placeholder);
    }
    ngOnChanges(changes) {
        if (changes.searchInput) {
            this.searchField.setValue(changes.searchInput.currentValue);
        }
    }
    ngOnDestroy() {
        this.subscriptions.forEach(s => s.unsubscribe());
    }
    subscribeToSearchFieldValueChanges() {
        return this.searchField.valueChanges.pipe(filter(searchInput => searchInput.length > this.searchThreshold), debounceTime(100), distinctUntilChanged(), switchMap(searchInput => this.suggest(searchInput))).subscribe(suggestResponse => {
            this.places = suggestResponse.places;
            this.collations = suggestResponse.collations;
        }); // Actual call is fired.
    }
    suggest(searchTerm) {
        const flArray = ['id', 'score', 'type', 'weergavenaam', ...this.resultFieldsToShow];
        const params = {
            fq: '*:*',
            fl: flArray.toString(),
            rows: this.resultCountLimit
        };
        if (this.type) {
            const replace = ',';
            const regex = new RegExp(replace, 'g');
            const query = this.type.replace(regex, ' OR ');
            params.fq = `type:(${query})`;
            if (this.province) {
                params.fq += ` AND provincienaam:(${this.province})`;
            }
        }
        else if (this.province) {
            params.fq = `provincienaam:(${this.province})`;
        }
        return this.geocoderService.suggest$(searchTerm, params);
    }
    free() {
        const searchTerm = this.searchField.value;
        const params = { fq: '*:*' };
        if (this.type) {
            const replace = ',';
            const regex = new RegExp(replace, 'g');
            const query = this.type.replace(regex, ' OR ');
            params.fq = `type:(${query})`;
            if (this.province) {
                params.fq += ` AND provincienaam:(${this.province})`;
            }
        }
        else if (this.province) {
            params.fq = `provincienaam:(${this.province})`;
        }
        return this.geocoderService.free$(searchTerm, params).subscribe(places => {
            this.places = places;
        });
    }
    lookup(id) {
        this.geocoderService.lookup$(id).subscribe((lookupObj) => {
            this.foundPlace = lookupObj;
            if (this.resultFieldsToShow.length > 0) {
                const input = this.resultFieldsToShow.map((resultFieldToShow) => {
                    return this.foundPlace[resultFieldToShow];
                }).join(', ');
                this.fillInput(input);
            }
            else {
                this.fillInput(this.foundPlace.weergavenaam);
            }
            this.placeFound.emit(this.foundPlace);
            this.clearPlaces();
        });
    }
    clear() {
        this.foundPlace = null;
        this.searchField.setValue('');
        this.clearPlaces();
    }
    clearPlaces() {
        this.resetIndex();
        this.places = [];
        this.collations = [];
    }
    handleEnter() {
        if (this.selectedIndex === -1) {
            return;
        }
        const selectedPlace = this.places[this.selectedIndex];
        this.lookup(selectedPlace.id);
    }
    isNoResultsFound() {
        const reachedThreshold = (this.searchField.value && this.searchField.value.length) > this.searchThreshold;
        const noSuggestions = this.places.length === 0;
        const noResult = (this.foundPlace == null);
        return (reachedThreshold) && (noSuggestions) && (noResult);
    }
    showCollations() {
        return this.collations.length > 0 && this.places.length === 0;
    }
    fillInput(content, emitEvent = false) {
        this.searchField.setValue(content, {
            emitEvent: emitEvent
        });
    }
    isHighlighted(i) {
        if (i === this.selectedIndex) {
            return true;
        }
    }
    moveUp() {
        if (this.selectedIndex > 0) {
            this.selectedIndex--;
        }
    }
    moveDown() {
        if (this.selectedIndex < this.places.length) {
            this.selectedIndex++;
        }
    }
    resetIndex() {
        this.selectedIndex = -1;
    }
    canQuery() {
        const searchInput = this.searchField.value;
        return searchInput && searchInput.length > this.searchThreshold;
    }
    canClear() {
        const searchInput = this.searchField.value;
        return searchInput && searchInput.length > 0;
    }
    formatPlaceholder(placeholder) {
        let placeholderText = 'Zoeken op de kaart...';
        if (placeholder) {
            placeholderText = placeholder;
        }
        return placeholderText;
    }
    onCollationClick(name) {
        this.fillInput(name, true);
    }
    showResults() {
        this.resultsVisible = true;
    }
    hideResults() {
        this.resultsVisible = false;
    }
}
GeocoderComponent.decorators = [
    { type: Component, args: [{
                template: "<div #geocoder (keydown.ArrowUp)=\"moveUp()\" (keydown.ArrowDown)=\"moveDown()\" (keydown.Enter)=\"handleEnter()\"\r\n  class=\"geocoder-container\">\r\n  <!-- Input -->\r\n  <div class=\"geocoder-search-container\">\r\n    <form [formGroup]=\"searchForm\">\r\n      <input (focus)=\"showResults()\" formControlName=\"search\" class=\"geocoder-search-input\" [placeholder]=\"formattedPlaceholder\" type=\"text\"\r\n        aria-label=\"Zoeken\" maxlength=\"100\">\r\n    </form>\r\n    <button class=\"searchButton\" aria-label=\"zoeken\" (click)=\"free()\" [ngClass]=\"{'highlight': canQuery()}\"> <svg\r\n        aria-hidden=\"true\" data-fa-processed=\"\" data-prefix=\"fal\" data-icon=\"search\" role=\"img\"\r\n        xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" class=\"svg-inline--fa fa-search fa-w-16 fa-9x\">\r\n        <path fill=\"currentColor\"\r\n          d=\"M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395 312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5 0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17 0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208 32s176 78.7 176 176-78.7 176-176 176z\"\r\n          class=\"\"></path>\r\n      </svg></button>\r\n    <button class=\"closeButton\" aria-label=\"zoekopdracht verwijderen\" (click)=\"clear()\"\r\n      [ngClass]=\"{'highlight': canClear()}\"> <svg aria-hidden=\"true\" data-fa-processed=\"\" data-prefix=\"fal\"\r\n        data-icon=\"times\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 384 512\"\r\n        class=\"svg-inline--fa fa-times fa-w-12 fa-7x\">\r\n        <path fill=\"currentColor\"\r\n          d=\"M217.5 256l137.2-137.2c4.7-4.7 4.7-12.3 0-17l-8.5-8.5c-4.7-4.7-12.3-4.7-17 0L192 230.5 54.8 93.4c-4.7-4.7-12.3-4.7-17 0l-8.5 8.5c-4.7 4.7-4.7 12.3 0 17L166.5 256 29.4 393.2c-4.7 4.7-4.7 12.3 0 17l8.5 8.5c4.7 4.7 12.3 4.7 17 0L192 281.5l137.2 137.2c4.7 4.7 12.3 4.7 17 0l8.5-8.5c4.7-4.7 4.7-12.3 0-17L217.5 256z\"\r\n          class=\"\"></path>\r\n      </svg></button>\r\n  </div>\r\n  <!-- Search results-->\r\n  <div class=\"geocoder-suggestions-container\" *ngIf=\"resultsVisible === true\">\r\n    <div class=\"geocoder-suggestions-results\" *ngIf=\"places.length > 0\">\r\n      <ul class=\"geocoder-suggestions-list\">\r\n        <li class=\"geocoder-suggestion\" tabindex={{i}} *ngFor=\"let place of places; let i = index;\"\r\n          (click)=\"lookup(place.id)\" [ngClass]=\"{'focus-background': isHighlighted(i)}\">\r\n          <p *ngIf=\"resultFieldsToShow.length === 0\" class=\"geocoder-suggestion-title\" [innerHTML]=\"place.highlight\">\r\n          </p>\r\n          <p *ngIf=\"resultFieldsToShow.length > 0\" class=\"geocoder-suggestion-title\">\r\n            <ng-container *ngFor=\"let field of resultFieldsToShow\">\r\n              {{place[field]}}\r\n            </ng-container>\r\n          </p>\r\n          <p class=\"geocoder-suggestion-type\"> {{place.type}} </p>\r\n        </li>\r\n      </ul>\r\n    </div>\r\n    <div class=\"geocoder-no-results\" *ngIf=\"isNoResultsFound()\">\r\n      <p>Geen zoekresultaten gevonden voor <strong> {{searchField.value}}</strong>.</p>\r\n    </div>\r\n    <div class=\"geocoder-collation-container\" *ngIf=\"showCollations()\">\r\n      <ul class=\"geocoder-collations-list\">\r\n        <li class=\"geocoder-collation\" tabindex={{i}} (click)=\"onCollationClick(collation.naam)\"\r\n          *ngFor=\"let collation of collations; let i = index;\" [innerHTML]=\"collation.weergavenaam\">\r\n        </li>\r\n      </ul>\r\n    </div>\r\n  </div>\r\n</div>\r\n",
                selector: 'geocoder',
                styles: ["::-webkit-input-placeholder{color:#797979;font-size:14px}:-moz-placeholder,::-moz-placeholder{color:#797979;font-size:14px}:-ms-input-placeholder{color:#797979;font-size:14px}::-ms-input-placeholder{color:#797979;font-size:14px}:-moz-placeholder-shown{color:#797979;font-size:14px}:placeholder-shown{color:#797979;font-size:14px}:focus{outline:0}input,li,p,span{color:#797979;font-size:14px;margin:0}.geocoder-container{max-width:100%;position:relative;width:100%}.geocoder-search-container{background:#fff;border:none;box-shadow:0 3px 6px rgba(0,0,0,.16),0 3px 6px rgba(0,0,0,.23);width:100%}.geocoder-search-input{border:none;max-width:100%;overflow:hidden;padding:15px;width:95%;width:calc(100% - 80px)}button{cursor:pointer;position:absolute}.searchButton{background:#fff;border:none;border-right:1px solid #797979;padding-right:15px;right:50px;top:13px}.closeButton{background:#fff;border:none;margin-left:16px;right:10px;top:10px}svg{color:#797979;width:18px}.closeButton:hover svg,.highlight svg,.searchButton:hover svg{color:#79abff;transition:all .1s cubic-bezier(.075,.82,.165,1)}.geocoder-suggestions-results{background:#fff;box-shadow:0 3px 6px rgba(0,0,0,.16),0 3px 6px rgba(0,0,0,.23);max-height:400px;overflow-y:auto;position:absolute;top:53px;width:100%;z-index:1}.geocoder-collations-list,.geocoder-suggestions-list{list-style-type:none;margin:0;padding:0}.geocoder-suggestion{border-bottom:1px solid #f1f1f1;padding:15px;position:relative}.geocoder-suggestion-title{max-width:243px}.geocoder-suggestion-type{color:#bfbfbf;font-size:11px;font-weight:700;position:absolute;right:15px;text-transform:uppercase;top:36%}.geocoder-collation:hover,.geocoder-suggestion:hover{background-color:#f7f7f7;cursor:pointer}.focus-background{background-color:#f7f7f7}.geocoder-no-results{background:#fff;box-shadow:0 3px 6px rgba(0,0,0,.16),0 3px 6px rgba(0,0,0,.23);box-sizing:border-box;padding:15px;position:absolute;top:53px;width:100%;z-index:1}.geocoder-collation{z-index:1}.geocoder-collation-container{background:#fff;box-shadow:0 3px 6px rgba(0,0,0,.16),0 3px 6px rgba(0,0,0,.23);position:absolute;top:108px;width:100%;z-index:1}.geocoder-collation-container li{border-bottom:1px solid #f1f1f1;padding:15px}.searchButton{height:20px}.closeButton{height:26px}"]
            },] }
];
GeocoderComponent.ctorParameters = () => [
    { type: GeocoderService }
];
GeocoderComponent.propDecorators = {
    geocoderRef: [{ type: ViewChild, args: ['geocoder', { static: false },] }],
    type: [{ type: Input }],
    searchInput: [{ type: Input }],
    placeholder: [{ type: Input }],
    resultCountLimit: [{ type: Input }],
    resultFieldsToShow: [{ type: Input }],
    province: [{ type: Input }],
    placeFound: [{ type: Output }],
    clickout: [{ type: HostListener, args: ['document:click', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvY29kZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2FwcC9nZW9jb2Rlci9nZW9jb2Rlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBVSxTQUFTLEVBQXlCLFlBQVksRUFBNEIsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHdkYsb0RBQW9EO0FBUXBELE1BQU0sT0FBTyxpQkFBaUI7SUErQjVCLFlBQW1CLGVBQWdDO1FBQWhDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQTFCMUMscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLHVCQUFrQixHQUFrQixFQUFFLENBQUM7UUFFdEMsZUFBVSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBQzNELHlCQUFvQixHQUFHLEVBQUUsQ0FBQztRQUMxQixtQkFBYyxHQUFHLElBQUksQ0FBQztRQUl0QixXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1osZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNoQixvQkFBZSxHQUFHLENBQUMsQ0FBQztRQUNwQixlQUFVLEdBQVEsSUFBSSxDQUFDO1FBQ3ZCLGlCQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLGtCQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFbEIsa0JBQWEsR0FBbUIsRUFBRSxDQUFDO1FBV3pDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUNyQyxJQUFJLENBQUMsVUFB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Q0FBQyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25Jbml0LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYsIE9uRGVzdHJveSwgSG9zdExpc3RlbmVyLCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgR2VvY29kZXJTZXJ2aWNlIH0gZnJvbSAnLi9nZW9jb2Rlci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTdWdnZXN0T3B0aW9ucyB9IGZyb20gJy4vbG9jYXRpZXNlcnZlci5tb2RlbCc7XHJcbi8vIExlYWZsZXQgcmVxdWlyZXMgdGhlIG9sZCBzY2hvb2wgd2F5IGZvciBpbXBvcnRpbmdcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHN0eWxlVXJsczogWydnZW9jb2Rlci5jb21wb25lbnQuc2NzcyddLFxyXG4gIHRlbXBsYXRlVXJsOiAnZ2VvY29kZXIuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHNlbGVjdG9yOiAnZ2VvY29kZXInXHJcbn0pXHJcblxyXG5leHBvcnQgY2xhc3MgR2VvY29kZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuICBAVmlld0NoaWxkKCdnZW9jb2RlcicsIHtzdGF0aWM6IGZhbHNlfSkgcHJpdmF0ZSBnZW9jb2RlclJlZjogRWxlbWVudFJlZjtcclxuICBASW5wdXQoKSB0eXBlOiBzdHJpbmc7XHJcbiAgQElucHV0KCkgc2VhcmNoSW5wdXQ6IHN0cmluZztcclxuICBASW5wdXQoKSBwbGFjZWhvbGRlcjogc3RyaW5nO1xyXG4gIEBJbnB1dCgpIHJlc3VsdENvdW50TGltaXQgPSAxMDtcclxuICBASW5wdXQoKSByZXN1bHRGaWVsZHNUb1Nob3c6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuICBASW5wdXQoKSBwcm92aW5jZTogc3RyaW5nO1xyXG4gIEBPdXRwdXQoKSBwbGFjZUZvdW5kOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG4gIHB1YmxpYyBmb3JtYXR0ZWRQbGFjZWhvbGRlciA9ICcnO1xyXG4gIHB1YmxpYyByZXN1bHRzVmlzaWJsZSA9IHRydWU7XHJcbiAgcHVibGljIHNlYXJjaEZpZWxkOiBGb3JtQ29udHJvbDtcclxuICBwdWJsaWMgc2VhcmNoRm9ybTogRm9ybUdyb3VwO1xyXG5cclxuICBwdWJsaWMgcGxhY2VzID0gW107XHJcbiAgcHVibGljIGNvbGxhdGlvbnMgPSBbXTtcclxuICBwdWJsaWMgc2VhcmNoVGhyZXNob2xkID0gMjtcclxuICBwdWJsaWMgZm91bmRQbGFjZTogYW55ID0gbnVsbDtcclxuICBwdWJsaWMgc2VsZWN0ZWRJdGVtID0gW107XHJcbiAgcHVibGljIHNlbGVjdGVkSW5kZXggPSAtMTtcclxuXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xyXG5cclxuICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpjbGljaycsIFsnJGV2ZW50J10pIGNsaWNrb3V0KGV2ZW50KSB7XHJcbiAgICBpZiAodGhpcy5nZW9jb2RlclJlZi5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcclxuICAgICAgdGhpcy5zaG93UmVzdWx0cygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5oaWRlUmVzdWx0cygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIGdlb2NvZGVyU2VydmljZTogR2VvY29kZXJTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLnNlYXJjaEZpZWxkID0gbmV3IEZvcm1Db250cm9sKCk7XHJcbiAgICB0aGlzLnNlYXJjaEZvcm0gPSBuZXcgRm9ybUdyb3VwKHsgc2VhcmNoOiB0aGlzLnNlYXJjaEZpZWxkIH0pO1xyXG5cclxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKFxyXG4gICAgICB0aGlzLnN1YnNjcmliZVRvU2VhcmNoRmllbGRWYWx1ZUNoYW5nZXMoKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuZm9ybWF0dGVkUGxhY2Vob2xkZXIgPSB0aGlzLmZvcm1hdFBsYWNlaG9sZGVyKHRoaXMucGxhY2Vob2xkZXIpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgaWYgKGNoYW5nZXMuc2VhcmNoSW5wdXQpIHtcclxuICAgICAgdGhpcy5zZWFyY2hGaWVsZC5zZXRWYWx1ZShjaGFuZ2VzLnNlYXJjaElucHV0LmN1cnJlbnRWYWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHMgPT4gcy51bnN1YnNjcmliZSgpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9TZWFyY2hGaWVsZFZhbHVlQ2hhbmdlcygpIHtcclxuICAgIHJldHVybiB0aGlzLnNlYXJjaEZpZWxkLnZhbHVlQ2hhbmdlcy5waXBlKFxyXG4gICAgICBmaWx0ZXIoc2VhcmNoSW5wdXQgPT4gc2VhcmNoSW5wdXQubGVuZ3RoID4gdGhpcy5zZWFyY2hUaHJlc2hvbGQpLFxyXG4gICAgICBkZWJvdW5jZVRpbWUoMTAwKSxcclxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcclxuICAgICAgc3dpdGNoTWFwKHNlYXJjaElucHV0ID0+IHRoaXMuc3VnZ2VzdChzZWFyY2hJbnB1dCkpXHJcbiAgICApLnN1YnNjcmliZShzdWdnZXN0UmVzcG9uc2UgPT4ge1xyXG4gICAgICB0aGlzLnBsYWNlcyA9IHN1Z2dlc3RSZXNwb25zZS5wbGFjZXM7XHJcbiAgICAgIHRoaXMuY29sbGF0aW9ucyA9IHN1Z2dlc3RSZXNwb25zZS5jb2xsYXRpb25zO1xyXG4gICAgfSk7IC8vIEFjdHVhbCBjYWxsIGlzIGZpcmVkLlxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdWdnZXN0KHNlYXJjaFRlcm06IHN0cmluZykge1xyXG4gICAgY29uc3QgZmxBcnJheSA9IFsnaWQnLCAnc2NvcmUnLCAndHlwZScsICd3ZWVyZ2F2ZW5hYW0nLCAuLi50aGlzLnJlc3VsdEZpZWxkc1RvU2hvd107XHJcbiAgICBjb25zdCBwYXJhbXMgPSB7XHJcbiAgICAgIGZxOiAnKjoqJyxcclxuICAgICAgZmw6IGZsQXJyYXkudG9TdHJpbmcoKSxcclxuICAgICAgcm93czogdGhpcy5yZXN1bHRDb3VudExpbWl0XHJcbiAgICB9IGFzIFN1Z2dlc3RPcHRpb25zO1xyXG4gICAgaWYgKHRoaXMudHlwZSkge1xyXG4gICAgICBjb25zdCByZXBsYWNlID0gJywnO1xyXG4gICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAocmVwbGFjZSwgJ2cnKTtcclxuICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLnR5cGUucmVwbGFjZShyZWdleCwgJyBPUiAnKTtcclxuICAgICAgcGFyYW1zLmZxID0gYHR5cGU6KCR7cXVlcnl9KWA7XHJcbiAgICAgIGlmICh0aGlzLnByb3ZpbmNlKSB7XHJcbiAgICAgICAgcGFyYW1zLmZxICs9IGAgQU5EIHByb3ZpbmNpZW5hYW06KCR7dGhpcy5wcm92aW5jZX0pYDtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmICh0aGlzLnByb3ZpbmNlKSB7XHJcbiAgICAgIHBhcmFtcy5mcSA9IGBwcm92aW5jaWVuYWFtOigke3RoaXMucHJvdmluY2V9KWA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZW9jb2RlclNlcnZpY2Uuc3VnZ2VzdCQoc2VhcmNoVGVybSwgcGFyYW1zKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBmcmVlKCkge1xyXG4gICAgY29uc3Qgc2VhcmNoVGVybSA9IHRoaXMuc2VhcmNoRmllbGQudmFsdWU7XHJcbiAgICBjb25zdCBwYXJhbXMgPSB7IGZxOiAnKjoqJyB9O1xyXG4gICAgaWYgKHRoaXMudHlwZSkge1xyXG4gICAgICBjb25zdCByZXBsYWNlID0gJywnO1xyXG4gICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAocmVwbGFjZSwgJ2cnKTtcclxuICAgICAgY29uc3QgcXVlcnkgPSB0aGlzLnR5cGUucmVwbGFjZShyZWdleCwgJyBPUiAnKTtcclxuICAgICAgcGFyYW1zLmZxID0gYHR5cGU6KCR7cXVlcnl9KWA7XHJcbiAgICAgIGlmICh0aGlzLnByb3ZpbmNlKSB7XHJcbiAgICAgICAgcGFyYW1zLmZxICs9IGAgQU5EIHByb3ZpbmNpZW5hYW06KCR7dGhpcy5wcm92aW5jZX0pYDtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmICh0aGlzLnByb3ZpbmNlKSB7XHJcbiAgICAgIHBhcmFtcy5mcSA9IGBwcm92aW5jaWVuYWFtOigke3RoaXMucHJvdmluY2V9KWA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZW9jb2RlclNlcnZpY2UuZnJlZSQoc2VhcmNoVGVybSwgcGFyYW1zKS5zdWJzY3JpYmUocGxhY2VzID0+IHtcclxuICAgICAgdGhpcy5wbGFjZXMgPSBwbGFjZXM7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBsb29rdXAoaWQ6IHN0cmluZykge1xyXG4gICAgdGhpcy5nZW9jb2RlclNlcnZpY2UubG9va3VwJChpZCkuc3Vic2NyaWJlKChsb29rdXBPYmopID0+IHtcclxuICAgICAgdGhpcy5mb3VuZFBsYWNlID0gbG9va3VwT2JqO1xyXG5cclxuICAgICAgaWYgKHRoaXMucmVzdWx0RmllbGRzVG9TaG93Lmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMucmVzdWx0RmllbGRzVG9TaG93Lm1hcCgocmVzdWx0RmllbGRUb1Nob3cpID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmZvdW5kUGxhY2VbcmVzdWx0RmllbGRUb1Nob3ddO1xyXG4gICAgICAgIH0pLmpvaW4oJywgJyk7XHJcbiAgICAgICAgdGhpcy5maWxsSW5wdXQoaW5wdXQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuZmlsbElucHV0KHRoaXMuZm91bmRQbGFjZS53ZWVyZ2F2ZW5hYW0pO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucGxhY2VGb3VuZC5lbWl0KHRoaXMuZm91bmRQbGFjZSk7XHJcbiAgICAgIHRoaXMuY2xlYXJQbGFjZXMoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgdGhpcy5mb3VuZFBsYWNlID0gbnVsbDtcclxuICAgIHRoaXMuc2VhcmNoRmllbGQuc2V0VmFsdWUoJycpO1xyXG4gICAgdGhpcy5jbGVhclBsYWNlcygpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNsZWFyUGxhY2VzKCkge1xyXG4gICAgdGhpcy5yZXNldEluZGV4KCk7XHJcbiAgICB0aGlzLnBsYWNlcyA9IFtdO1xyXG4gICAgdGhpcy5jb2xsYXRpb25zID0gW107XHJcbiAgfVxyXG5cclxuXHJcbiAgcHVibGljIGhhbmRsZUVudGVyKCkge1xyXG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRJbmRleCA9PT0gLTEpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2VsZWN0ZWRQbGFjZSA9IHRoaXMucGxhY2VzW3RoaXMuc2VsZWN0ZWRJbmRleF07XHJcbiAgICB0aGlzLmxvb2t1cChzZWxlY3RlZFBsYWNlLmlkKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBpc05vUmVzdWx0c0ZvdW5kKCkge1xyXG4gICAgY29uc3QgcmVhY2hlZFRocmVzaG9sZCA9ICh0aGlzLnNlYXJjaEZpZWxkLnZhbHVlICYmIHRoaXMuc2VhcmNoRmllbGQudmFsdWUubGVuZ3RoKSA+IHRoaXMuc2VhcmNoVGhyZXNob2xkO1xyXG4gICAgY29uc3Qgbm9TdWdnZXN0aW9ucyA9IHRoaXMucGxhY2VzLmxlbmd0aCA9PT0gMDtcclxuICAgIGNvbnN0IG5vUmVzdWx0ID0gKHRoaXMuZm91bmRQbGFjZSA9PSBudWxsKTtcclxuICAgIHJldHVybiAocmVhY2hlZFRocmVzaG9sZCkgJiYgKG5vU3VnZ2VzdGlvbnMpICYmIChub1Jlc3VsdCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2hvd0NvbGxhdGlvbnMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jb2xsYXRpb25zLmxlbmd0aCA+IDAgJiYgdGhpcy5wbGFjZXMubGVuZ3RoID09PSAwO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGZpbGxJbnB1dChjb250ZW50OiBzdHJpbmcsIGVtaXRFdmVudCA9IGZhbHNlKSB7XHJcbiAgICB0aGlzLnNlYXJjaEZpZWxkLnNldFZhbHVlKGNvbnRlbnQsIHtcclxuICAgICAgZW1pdEV2ZW50OiBlbWl0RXZlbnRcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGlzSGlnaGxpZ2h0ZWQoaSkge1xyXG4gICAgaWYgKGkgPT09IHRoaXMuc2VsZWN0ZWRJbmRleCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBtb3ZlVXAoKSB7XHJcbiAgICBpZiAodGhpcy5zZWxlY3RlZEluZGV4ID4gMCkge1xyXG4gICAgICB0aGlzLnNlbGVjdGVkSW5kZXgtLTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBtb3ZlRG93bigpIHtcclxuICAgIGlmICh0aGlzLnNlbGVjdGVkSW5kZXggPCB0aGlzLnBsYWNlcy5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5zZWxlY3RlZEluZGV4Kys7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVzZXRJbmRleCgpIHtcclxuICAgIHRoaXMuc2VsZWN0ZWRJbmRleCA9IC0xO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNhblF1ZXJ5KCkge1xyXG4gICAgY29uc3Qgc2VhcmNoSW5wdXQgPSB0aGlzLnNlYXJjaEZpZWxkLnZhbHVlO1xyXG4gICAgcmV0dXJuIHNlYXJjaElucHV0ICYmIHNlYXJjaElucHV0Lmxlbmd0aCA+IHRoaXMuc2VhcmNoVGhyZXNob2xkO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNhbkNsZWFyKCkge1xyXG4gICAgY29uc3Qgc2VhcmNoSW5wdXQgPSB0aGlzLnNlYXJjaEZpZWxkLnZhbHVlO1xyXG4gICAgcmV0dXJuIHNlYXJjaElucHV0ICYmIHNlYXJjaElucHV0Lmxlbmd0aCA+IDA7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZm9ybWF0UGxhY2Vob2xkZXIocGxhY2Vob2xkZXI6IHN0cmluZykge1xyXG4gICAgbGV0IHBsYWNlaG9sZGVyVGV4dCA9ICdab2VrZW4gb3AgZGUga2FhcnQuLi4nO1xyXG5cclxuICAgIGlmIChwbGFjZWhvbGRlcikge1xyXG4gICAgICBwbGFjZWhvbGRlclRleHQgPSBwbGFjZWhvbGRlcjtcclxuICAgIH1cclxuICAgIHJldHVybiBwbGFjZWhvbGRlclRleHQ7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Db2xsYXRpb25DbGljayhuYW1lOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuZmlsbElucHV0KG5hbWUsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNob3dSZXN1bHRzKCkge1xyXG4gICAgdGhpcy5yZXN1bHRzVmlzaWJsZSA9IHRydWU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhpZGVSZXN1bHRzKCkge1xyXG4gICAgdGhpcy5yZXN1bHRzVmlzaWJsZSA9IGZhbHNlO1xyXG4gIH1cclxufVxyXG4iXX0=